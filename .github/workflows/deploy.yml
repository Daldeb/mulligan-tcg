name: 🚀 Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to OVH Server
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🚀 Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 51.178.27.41
        username: debian
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          echo "🔄 Starting deployment..."
          cd /opt/tcg-hub
          
          echo "📥 Pulling latest changes..."
          git pull origin main
          
          echo "🔧 Configuring production environment..."
          cat > app/symfony/.env.local << 'EOF'
          APP_ENV=prod
          DATABASE_URL=mysql://tcg_prod_user:tcg_prod_password@tcg_prod_mysql:3306/tcg_prod_db
          MYSQL_USER=tcg_prod_user
          MYSQL_PASSWORD=tcg_prod_password
          MYSQL_DATABASE=tcg_prod_db
          MYSQL_ROOT_PASSWORD=root_password
          REDIS_URL=redis://redis:6379
          JWT_SECRET_KEY=your-jwt-secret-key-change-this
          MESSENGER_TRANSPORT_DSN=sync://
          CORS_ALLOW_ORIGIN=https://51.178.27.41
          VUE_APP_API_URL=http://51.178.27.41/api
          MAILER_DSN=smtp://localhost:25
          DEBUG=false
          LOG_LEVEL=info
          EOF
          
          echo "📦 Building frontend Vue.js..."
          cd app/vuejs
          npm install
          npm run build
          cd ../..

          echo "📁 Copying frontend files to container..."
          docker cp app/vuejs/dist/ tcg_prod_app:/var/www/frontend/

          echo "🐳 Rebuilding production containers..."
          docker compose down
          docker compose up -d --build

          echo "🧹 Removing fallback .env from container..."
          docker exec tcg_prod_app bash -c "rm -f /var/www/backend/.env"

          echo "⏳ Waiting for services..."
          sleep 10
          
          echo "🔍 Health check..."
          curl -f http://localhost/ || echo "Health check failed but continuing..."
          
          echo "🗃️ Running database migrations..."
          docker exec tcg_prod_app bash -c "cd /var/www/backend && php bin/console doctrine:migrations:migrate --no-interaction"
          
          echo "🧹 Clearing Symfony cache..."
          docker exec tcg_prod_app bash -c "cd /var/www/backend && php bin/console cache:clear --env=prod"
          
          echo "🔄 Installing/updating Symfony dependencies..."
          docker exec tcg_prod_app bash -c "cd /var/www/backend && composer install --no-dev --optimize-autoloader"
          
          echo "✅ Deployment completed successfully!"
          echo "🌐 Site available at: http://51.178.27.41"
          echo "🗃️ Database: Migrations applied"
          echo "📦 Frontend: Built and deployed"
