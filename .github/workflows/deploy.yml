name: ğŸš€ Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to OVH Server
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸš€ SSH & Deploy to Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_IP }}
        username: debian
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          echo "ğŸ”„ Resetting local repo to match origin..."
          cd /opt/tcg-hub
          git fetch origin
          git reset --hard origin/main

          echo "ğŸ“¦ Building frontend (Vue)..."
          cd app/vuejs
          npm install
          npm run build
          cd ../../

          echo "ğŸ§¹ Cleaning containers but keeping data..."
          docker compose -f infrastructure/docker-compose.prod.yaml down --remove-orphans

          echo "ğŸ³ Rebuilding Docker stack..."
          docker compose -f infrastructure/docker-compose.prod.yaml up -d --build

          echo "â³ Waiting for services to be ready..."
          sleep 15

          echo "ğŸ“ Installing Symfony dependencies..."
          docker exec tcg_prod_app composer install --no-dev --optimize-autoloader

          echo "ğŸ§¹ Clearing Symfony cache..."
          docker exec tcg_prod_app php bin/console cache:clear --env=prod

          echo "ğŸ—ƒï¸ Running Doctrine migrations..."
          docker exec tcg_prod_app php bin/console doctrine:migrations:migrate --no-interaction

          echo "âœ… Deployed successfully!"