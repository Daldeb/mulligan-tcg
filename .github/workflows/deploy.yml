name: ğŸš€ Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: ğŸš€ SSH & Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸš€ SSH & Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: debian
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            echo "ğŸ”„ Resetting local repo to match origin..."
            cd /opt/tcg-hub
            git fetch origin
            git reset --hard origin/main

            echo "ğŸ“¦ Building frontend (Vue)..."
            cd app/vuejs
            npm install
            npm run build
            cd ../../

            echo "ğŸ’¾ Sauvegarde de la base de donnÃ©es MySQL..."
            mkdir -p /opt/tcg-hub/backups
            NOW=$(date +"%Y%m%d_%H%M%S")
            BACKUP_FILE="/opt/tcg-hub/backups/mysql_backup_$NOW.sql"
            docker exec tcg_prod_mysql mysqldump -u tcg_prod_user -ptcg_prod_password tcg_prod_db > "$BACKUP_FILE"

            echo "ğŸ§¹ Nettoyage des anciens backups (garder les 15 derniers)..."
            ls -1t /opt/tcg-hub/backups/mysql_backup_*.sql | tail -n +16 | xargs -r rm -f

            echo "ğŸ§¹ Cleaning containers but keeping data..."

            echo "ğŸ§¹ Nettoyage dur des containers orphelins..."
            docker rm -f tcg_prod_app || true
            docker rm -f tcg_prod_mysql || true
            docker rm -f tcg_prod_redis || true

            docker compose -f infrastructure/docker-compose.prod.yaml down --remove-orphans

            echo "ğŸ³ Rebuilding Docker stack..."
            docker compose -f infrastructure/docker-compose.prod.yaml up -d --build --force-recreate

            echo "â³ Waiting for all services to be ready..."
            sleep 5

            echo "ğŸ” Ensuring all services are running..."
            docker compose -f infrastructure/docker-compose.prod.yaml up -d

            echo "ğŸ“ Installing Symfony dependencies..."
            docker exec tcg_prod_app composer install --no-dev --optimize-autoloader

            echo "ğŸ§¹ Clearing Symfony cache..."
            docker exec tcg_prod_app php bin/console cache:clear --env=prod

            echo "ğŸ—ƒï¸ Running Doctrine migrations..."
            docker exec tcg_prod_app php bin/console doctrine:migrations:migrate --no-interaction || echo "Migration failed, but continuing..."

            echo "âœ… Deployed successfully!"
