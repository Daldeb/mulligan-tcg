name: 🚀 Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to OVH Server
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4

    - name: 🚀 SSH & Deploy to Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_IP }}
        username: debian
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          echo "🔄 Resetting local repo to match origin..."
          cd /opt/tcg-hub
          git fetch origin
          git reset --hard origin/main

          echo "📦 Building frontend (Vue)..."
          cd app/vuejs
          npm install
          npm run build
          cd ../../

          echo "🧹 Cleaning containers but keeping data..."
          docker compose -f infrastructure/docker-compose.prod.yaml down --remove-orphans

          echo "🐳 Rebuilding Docker stack..."
          docker compose -f infrastructure/docker-compose.prod.yaml up -d --build --force-recreate

          echo "⏳ Waiting for all services to be ready..."
          sleep 30

          echo "🔍 Ensuring all services are running..."
          docker compose -f infrastructure/docker-compose.prod.yaml up -d

          echo "🏥 Checking service health..."
          docker ps --format "table {{.Names}}\t{{.Status}}"

          echo "📁 Installing Symfony dependencies..."
          docker exec tcg_prod_app composer install --no-dev --optimize-autoloader

          echo "🧹 Clearing Symfony cache..."
          docker exec tcg_prod_app php bin/console cache:clear --env=prod

          echo "🗃️ Running Doctrine migrations..."
          docker exec tcg_prod_app php bin/console doctrine:migrations:migrate --no-interaction || echo "Migration failed, but continuing..."

          echo "✅ Deployed successfully!"
